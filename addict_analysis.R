# title: "addict_analysis"
# author: "Chenghao Zhou"
# date: "8/21/2021"
# R-4.0.5

#### addict####
# step_0:load & clean data
# step_1:psychological measurement
# step_2:factor analysis
# step_3:Measurement invariance


#### check environment####
# Clear objects from the workspace
rm(list = ls())

# set working directory
curWD <- dirname(rstudioapi::getSourceEditorContext()$path) 
setwd(curWD)

# check packages we need
pacman::p_load(psych,bruceR,lavaan,semPlot,readxl,semTools)


#### load & clean data ####
rawdata_all <- read.csv("726addict_self_scale_total.csv")
head(rawdata_all) #ï..ID

# remove ID, keep useful data
addict_useful <- subset(rawdata_all,select = -c(ï..ID,A16,A23,A43)) #DROP id + Cehuang+我自认为是一个耽美爱好者
head_name <- names(addict_useful)

# check if exist NA
anyNA(addict_useful)

#### psychological measurement ####
# describe the by columns
apply(addict_useful, 2, psych::describe)


#caculate the real
res_addict_orig <- bruceR::Alpha(addict_useful,vars = head_name) 
#Cronbach's α = 0.9658835 / McDonald's ω = 0.9664850


# correlations
correlations_addict_orig <- cor(addict_useful) 

###factor number
tiff(file = "orig_addict_scree_plot.tiff", res = 600, width = 4800, height = 4800, compression = "lzw")
psych::fa.parallel(correlations_addict_orig, n.obs = 506, fa = "both", n.iter = 1000, main = "Parallel analysis gravel diagram")
dev.off()
#Parallel analysis suggests that the number of factors =  6  and the number of components =  3 


factor_num <- c(2:12)
for ( n in factor_num){
### EFA
# PCA + varimax rotate
pca_addict_orig.varimax <- psych::principal(addict_useful, nfactors = n, rotate = "varimax") #pca + varimax rotate
# plot factor
stre = paste('EFA_Orig_',n,'pca_addict_factor.tiff')
tiff(file = stre, res = 600, width = 4800, height = 4800, compression = "lzw")
factor.plot(pca_addict_orig.varimax, labels = rownames(pca_addict_orig.varimax$loadings))
dev.off()

# plot diagram
stre = paste('EFA_Orig_',n,'pca_addict_diagram.tiff')
tiff(file = stre, res = 600, width = 4800, height = 4800, compression = "lzw")
fa.diagram(pca_addict_orig.varimax, digits = 9)
dev.off()
}

### CFA
addict_orig_6.model <- '#6个维度
RS =~ A1 + A3 + A20 + A42 + A44 + A45 + A46 
PF =~ A2 + A5 + A6 + A7 + A8 + A9 
WD =~ A10 + A11 + A13 + A21 + A22  
TM =~ A17 + A18 + A19 + A24 + A25  
FS =~ A40 + A35 + A36  
CS =~ A4 + A12 + A14 + A15 + A26 + A27 + A28 + A29 + A30 + A31 + A32 + A33 + A34 + A37 + A38 + A39 + A41 
'

addict_orig_6.fit <- lavaan::cfa(addict_orig_6.model, data = addict_useful)

fitMeasures(addict_orig_6.fit)  

addict_orig_6.res_std_addict_6 <- standardizedSolution(addict_orig_6.fit)


#plot_style_1
tiff(file = "CFA_addict_orig6_semPlot_style_1.tiff", res = 600, width = 4800, height = 4800, compression = "lzw")

semPlot::semPaths(object =addict_orig_6.fit,
         whatLabels = "stand", 
         what = "stand", 
         style = "OpenMx",
         layout = "tree",
         rotation = 2,
         edge.label.cex = 0.5,
         sizeLat = 6,
         sizeLat2 = 4,
         sizeMan = 2,
         sizeInt = 3,
         gui = TRUE,
         optimizeLatRes = TRUE,
         label.norm = "OOOOO",
         mar=c(2,6,2,4),
         residuals = TRUE,
         curvePivot = TRUE)
dev.off()

#plot_style_2
tiff(file = "CFA_addict_orig6_semPlot_style_2.tiff", res = 600, width = 4800, height = 4800, compression = "lzw")

semPlot::semPaths(object =addict_orig_6.fit,
                  "std",rotation = 2,layout = "tree2",nCharNodes = 0,
                  sizeLat = 3, sizeLat2 = 3, label.norm = "OOOOO", 
                  mar=c(2,6,2,4), curvePivot = TRUE,
                  edge.label.cex=0.4, residuals = F)
dev.off()

#### Measurement invariance ####
# load data
Measurement_invariance_addict_data <- read_excel("820Measurement invariance_addict.xlsx")
View(Measurement_invariance_addict_data)

### Residence urban/city or rural
label_Residence <- Measurement_invariance_addict_data$label1_Residence
MI_Residence_data <- cbind(label_Residence,addict_useful)
MI_Residence_data$label_Residence <- factor(MI_Residence_data$label_Residence,levels = c("1","2"))

addict_orig_6.R_config <- cfa(addict_orig_6.model, MI_Residence_data, group="label_Residence")  
addict_orig_6.R_weak <- cfa(addict_orig_6.model, MI_Residence_data, group="label_Residence", group.equal="loadings") 
addict_orig_6.R_strong<- cfa(addict_orig_6.model, MI_Residence_data, group="label_Residence", group.equal= c("loadings", "intercepts"))
addict_orig_6.R_strict<- cfa(addict_orig_6.model, MI_Residence_data, group="label_Residence", 
             group.equal= c("loadings", "intercepts", "residuals"))

addict_orig_6.R_anova <- anova(addict_orig_6.R_config, addict_orig_6.R_weak, addict_orig_6.R_strong, addict_orig_6.R_strict)
# Chi-Squared Difference Test
# 
# Df   AIC   BIC  Chisq Chisq diff Df diff Pr(>Chisq)   
# addict_orig_6.config 1690 55107 56324 4532.9                                 
# addict_orig_6.weak   1727 55101 56162 4601.2     68.219      37   0.001338 **
#   addict_orig_6.strong 1764 55057 55961 4631.0     29.815      37   0.793181   
# addict_orig_6.strict 1807 55034 55757 4693.8     62.789      43   0.026006 * 
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

addict_orig_6.R_MI <- semTools::measurementInvariance(model = addict_orig_6.model, data = MI_Residence_data, group = "label_Residence")
# Measurement invariance models:
#   
# Model 1 : fit.configural
# Model 2 : fit.loadings
# Model 3 : fit.intercepts
# Model 4 : fit.means
# 
# Chi-Squared Difference Test
# 
# Df   AIC   BIC  Chisq Chisq diff Df diff Pr(>Chisq)   
# fit.configural 1690 55107 56324 4532.9                                 
# fit.loadings   1727 55101 56162 4601.2     68.219      37   0.001338 **
# fit.intercepts 1764 55057 55961 4631.0     29.815      37   0.793181   
# fit.means      1770 55046 55925 4631.7      0.736       6   0.993684   
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# 
# Fit measures:
#   
#   cfi rmsea cfi.delta rmsea.delta
# fit.configural 0.820 0.082        NA          NA
# fit.loadings   0.818 0.081     0.002       0.000
# fit.intercepts 0.818 0.080     0.000       0.001
# fit.means      0.819 0.080     0.000       0.000


addict_orig_6.R_partialInvariance <- semTools::partialInvariance(addict_orig_6.R_MI, "metric", free = NULL, fix = NULL, refgroup = 1,
                  poolvar = TRUE, p.adjust = "none", fbound = 2, return.fit = FALSE,
                  method = "satorra.bentler.2001") 

# $estimates
# poolest    load:2    load:1     std:2     std:1 diff_std:1 vs. 2     q:1 vs. 2 diff_mean:1 vs. 2
# RS=~A1  1.0000000 1.2797415 1.2320325 0.8057229 0.7756854    -0.0300374817 -0.0802692179     -0.0193236715
# RS=~A3  0.7945670 0.8888909 0.6223750 0.7292786 0.5106193    -0.2186593290 -0.3636175898     -0.0133779264
# RS=~A20 0.9900821 1.0418610 0.9041488 0.7891342 0.6848272    -0.1043069914 -0.2309839824     -0.0133779264
# RS=~A42 0.7757517 0.7478206 0.8273200 0.6110841 0.6760473     0.0649632012  0.1111482666      0.0694908956
# RS=~A44 0.5770551 0.5131657 0.6858611 0.5413148 0.7234832     0.1821684496  0.3089021194      0.0828688220
# RS=~A45 1.1425090 1.1227161 1.1801483 0.8627731 0.9069080     0.0441348758  0.2057319936      0.0241545894
# RS=~A46 1.1677557 1.1548820 1.1927798 0.8827015 0.9116677     0.0289661060  0.1494417164      0.0520252694
# PF=~A2  1.0000000 1.1432458 1.2985100 0.7115949 0.8082366     0.0966416877  0.2315151033     -0.0631735414
# PF=~A5  0.7562464 0.7593555 0.7496211 0.6761289 0.6674615    -0.0086674792 -0.0157974165      0.0163507990
# PF=~A6  0.8484703 0.8775193 0.7779753 0.8485277 0.7522725    -0.0962552460 -0.2727013879      0.0746934225
# PF=~A7  0.9078038 0.8755151 0.9747179 0.6818739 0.7591356     0.0772617003  0.1615638312      0.0698625046
# PF=~A8  0.8652454 0.8235167 0.9351515 0.6590838 0.7484283     0.0893444341  0.1781800704     -0.0111482720
# PF=~A9  0.9108784 0.9423353 0.8532780 0.8719485 0.7895433    -0.0824052202 -0.2709334551      0.0561129692
# WD=~A10 1.0000000 1.3642924 1.2771028 0.7092149 0.6638902    -0.0453247280 -0.0858646431      0.0267558528
# WD=~A11 0.7547118 0.7163123 0.8207679 0.5484000 0.6283700     0.0799699543  0.1226276691      0.1099962839
# WD=~A13 0.6218859 0.5678536 0.6919767 0.5576678 0.6795644     0.1218966514  0.1988623943     -0.0144927536
# WD=~A21 0.8336101 0.8809422 0.7652633 0.8275100 0.7188474    -0.1086625874 -0.2749293374     -0.0683760684
# WD=~A22 1.0163194 1.0042727 1.0335933 0.7561313 0.7782072     0.0220758988  0.0536893711     -0.0029728725
# TM=~A17 1.0000000 1.1040184 1.1172016 0.5877596 0.5947781     0.0070185063  0.0107912576     -0.0293571163
# TM=~A18 1.1781996 1.0469778 1.5600271 0.7063692 1.0525105     0.3461412875  4.0718188468      0.0735785953
# TM=~A19 0.8093248 0.8247690 0.7801744 0.4950520 0.4682849    -0.0267670935 -0.0348591761      0.0044593088
# TM=~A24 0.6674414 0.7266962 0.5218864 0.7542203 0.5416531    -0.2125671126 -0.3761798000      0.0037160907
# TM=~A25 0.9962900 1.0479047 0.8747827 0.7865024 0.6565661    -0.1299362993 -0.2754409690     -0.0460795243
# FS=~A40 1.0000000 0.9727904 1.2889162 0.6432021 0.8522223     0.2090201652  0.5005997193      0.0471943515
# FS=~A35 1.3221121 1.3603692 1.2561513 0.8110762 0.7489396    -0.0621365737 -0.1596306418      0.0442214790
# FS=~A36 1.3957475 1.4821840 1.2811362 0.9296982 0.8035912    -0.1261070162 -0.5474924478     -0.0471943515
# CS=~A4  1.0000000 0.9801002 0.9804954 0.6684187 0.6686882     0.0002695287  0.0004873616      0.1007060572
# CS=~A12 1.1036137 1.0804658 1.1437754 0.6846778 0.7247963     0.0401185075  0.0798090332     -0.0654031958
# CS=~A14 1.1568772 1.0938506 1.2522065 0.6728417 0.7702485     0.0974067494  0.2050208897     -0.0033444816
# CS=~A15 0.9918407 1.0200896 0.9471011 0.6506962 0.6041382    -0.0465579925 -0.0768667927      0.0672612412
# CS=~A26 1.2336920 1.2494229 1.2087877 0.7877100 0.7620912    -0.0256188362 -0.0641842525      0.0007432181
# CS=~A27 1.3207716 1.3430544 1.2857840 0.8559857 0.8194849    -0.0365008736 -0.1228824085     -0.0222965440
# CS=~A28 1.2244123 1.2913713 1.1123923 0.8642888 0.7445017    -0.1197870717 -0.3495485259      0.1077666295
# CS=~A29 1.3888094 1.4207144 1.3290035 0.8960088 0.8381690    -0.0578397403 -0.2366134095      0.0174656262
# CS=~A30 1.4096198 1.3934826 1.4323978 0.8382591 0.8616688     0.0234097071  0.0844995996     -0.0115198811
# CS=~A31 1.2350773 1.2066899 1.2776597 0.7414287 0.7850348     0.0436061234  0.1047137398      0.0899293943
# CS=~A32 0.9040198 0.9299209 0.8569850 0.5973454 0.5504942    -0.0468511775 -0.0699194834     -0.1070234114
# CS=~A33 1.3556801 1.3060351 1.4279563 0.7898923 0.8636304     0.0737381385  0.2363113125      0.0657748049
# CS=~A34 1.2010595 1.1590656 1.2698639 0.6916345 0.7577497     0.0661152261  0.1398267910      0.1092530658
# CS=~A37 1.1578170 1.1784907 1.1292603 0.7390276 0.7081554    -0.0308721840 -0.0648593842      0.1460423634
# CS=~A38 0.9670543 0.9269848 1.0215373 0.6419621 0.7074422     0.0654801254  0.1205406105      0.0657748049
# CS=~A39 1.0876359 1.0468936 1.1495741 0.6866429 0.7539896     0.0673466705  0.1405611726      0.0434782609
# CS=~A41 1.2379900 1.2561203 1.2059371 0.7440458 0.7143205    -0.0297253663 -0.0635315517     -0.1315496098
# low_fscore:1 vs. 2 high_fscore:1 vs. 2
# RS=~A1          0.05522919       -9.387653e-02
# RS=~A3          0.50828000       -5.350358e-01
# RS=~A20         0.25693967       -2.836955e-01
# RS=~A42        -0.08800290        2.269847e-01
# RS=~A44        -0.26045631        4.261940e-01
# RS=~A45        -0.08989201        1.382012e-01
# RS=~A46        -0.02314623        1.271968e-01
# PF=~A2         -0.28198063        1.556335e-01
# PF=~A5          0.03269875        2.851448e-06
# PF=~A6          0.24039128       -9.100443e-02
# PF=~A7         -0.09749841        2.372234e-01
# PF=~A8         -0.19962128        1.773247e-01
# PF=~A9          0.20421276       -9.198683e-02
# WD=~A10         0.14273261       -8.922090e-02
# WD=~A11        -0.07728285        2.972754e-01
# WD=~A13        -0.23786399        2.088785e-01
# WD=~A21         0.13665027       -2.734024e-01
# WD=~A22        -0.05537036        4.942462e-02
# TM=~A17        -0.04782751       -1.088672e-02
# TM=~A18        -0.75102040        8.981776e-01
# TM=~A19         0.07357207       -6.465345e-02
# TM=~A24         0.31549823       -3.080660e-01
# TM=~A25         0.21926870       -3.114277e-01
# FS=~A40        -0.32649070        4.208794e-01
# FS=~A35         0.17508554       -8.664258e-02
# FS=~A36         0.20073493       -2.951236e-01
# CS=~A4          0.10003118        1.013809e-01
# CS=~A12        -0.17145602        4.064963e-02
# CS=~A14        -0.26895551        2.622666e-01
# CS=~A15         0.18933110       -5.480861e-02
# CS=~A26         0.06870884       -6.722240e-02
# CS=~A27         0.07341924       -1.180123e-01
# CS=~A28         0.40585852       -1.903253e-01
# CS=~A29         0.17046173       -1.355305e-01
# CS=~A30        -0.07673026        5.369050e-02
# CS=~A31        -0.02900967        2.088685e-01
# CS=~A32         0.01497942       -2.290262e-01
# CS=~A33        -0.13896355        2.705132e-01
# CS=~A34        -0.07650672        2.950128e-01
# CS=~A37         0.22838842        6.369631e-02
# CS=~A38        -0.09267094        2.242205e-01
# CS=~A39        -0.12863841        2.155949e-01
# CS=~A41        -0.04760481       -2.154944e-01
# 
# $results
# free.chi free.df       free.p      free.cfi      fix.chi fix.df      fix.p       fix.cfi
# RS=~A1  2.246839e-01       2 0.8937385917  1.125698e-04           NA     NA         NA            NA
# RS=~A3  8.257798e+00       1 0.0040577321 -4.602045e-04 4.5378389741      1 0.03315342 -2.243283e-04
# RS=~A20 2.389803e+00       1 0.1221289795 -8.812506e-05 0.6859778461      1 0.40753584  1.991161e-05
# RS=~A42 7.158844e-01       1 0.3974972309  1.801528e-05 1.0380683288      1 0.30827115 -2.413848e-06
# RS=~A44 5.537011e+00       1 0.0186183538 -2.876841e-04 4.9530618359      1 0.02604450 -2.506569e-04
# RS=~A45 6.519860e-01       1 0.4194035303  2.206697e-05 0.8049099508      1 0.36962942  1.237033e-05
# RS=~A46 2.938002e-01       1 0.5877954999  4.477892e-05 0.5095417240      1 0.47533731  3.109912e-05
# PF=~A2  1.806820e+00       2 0.4051855488  1.224919e-05           NA     NA         NA            NA
# PF=~A5  1.234170e-02       1 0.9115424367  6.262572e-05 0.8591746494      1 0.35396976  8.929494e-06
# PF=~A6  2.008911e+00       1 0.1563775552 -6.397330e-05 3.5975061574      1 0.05786632 -1.647034e-04
# PF=~A7  1.052509e+00       1 0.3049298507 -3.329533e-06 0.0001613632      1 0.98986484  6.339805e-05
# PF=~A8  1.412415e+00       1 0.2346559829 -2.615050e-05 0.0121101089      1 0.91237294  6.264041e-05
# PF=~A9  1.637256e+00       1 0.2007023224 -4.040733e-05 2.9794384840      1 0.08432852 -1.255128e-04
# WD=~A10 3.069050e-01       2 0.8577414987  1.073563e-04           NA     NA         NA            NA
# WD=~A11 8.885027e-01       1 0.3458833750  7.069850e-06 1.0098268133      1 0.31494433 -6.231014e-07
# WD=~A13 2.210928e+00       1 0.1370362333 -7.678286e-05 1.7963392757      1 0.18015569 -5.049451e-05
# WD=~A21 2.225529e+00       1 0.1357461433 -7.770870e-05 0.1447510608      1 0.70360277  5.422987e-05
# WD=~A22 8.902555e-02       1 0.7654196356  5.776333e-05 0.1519856053      1 0.69664502  5.377114e-05
# TM=~A17 5.924062e-03       2 0.9970423514  1.264409e-04           NA     NA         NA            NA
# TM=~A18 1.361586e+01       1 0.0002242824 -7.999502e-04 1.5486895182      1 0.21332901 -3.479146e-05
# TM=~A19 8.460179e-02       1 0.7711554422  5.804383e-05 0.3952817637      1 0.52953607  3.834415e-05
# TM=~A24 5.809324e+00       1 0.0159414202 -3.049510e-04 3.7410578328      1 0.05309082 -1.738058e-04
# TM=~A25 2.394298e+00       1 0.1217784314 -8.841003e-05 1.9050492350      1 0.16751424 -5.738762e-05
# FS=~A40 7.038598e+00       2 0.0296201955 -3.194888e-04           NA     NA         NA            NA
# FS=~A35 5.980518e-01       1 0.4393223082  2.548684e-05 4.6092360054      1 0.03180020 -2.288555e-04
# FS=~A36 2.486004e+00       1 0.1148629984 -9.422499e-05 6.1267110539      1 0.01331544 -3.250760e-04
# CS=~A4  1.455543e-05       2 0.9999927223  1.268157e-04           NA     NA         NA            NA
# CS=~A12 3.433851e-01       1 0.5578817432  4.163482e-05 0.1362288039      1 0.71205925  5.477025e-05
# CS=~A14 2.136638e+00       1 0.1438167729 -7.207227e-05 0.8473274733      1 0.35730948  9.680703e-06
# CS=~A15 4.041080e-01       1 0.5249753147  3.778449e-05 0.2374596621      1 0.62604693  4.835138e-05
# CS=~A26 1.788036e-01       1 0.6724034314  5.207066e-05 0.0946853392      1 0.75830314  5.740445e-05
# CS=~A27 4.717921e-01       1 0.4921638856  3.349276e-05 0.1634603098      1 0.68599047  5.304355e-05
# CS=~A28 4.492556e+00       1 0.0340427507 -2.214570e-04 1.3478154843      1 0.24566038 -2.205438e-05
# CS=~A29 1.350684e+00       1 0.2451586601 -2.223624e-05 0.3186067283      1 0.57244616  4.320598e-05
# CS=~A30 2.043213e-01       1 0.6512551565  5.045262e-05 0.0425831626      1 0.83651215  6.070816e-05
# CS=~A31 4.914118e-01       1 0.4832982264  3.224871e-05 0.1730054446      1 0.67745447  5.243831e-05
# CS=~A32 3.634869e-01       1 0.5465760723  4.036021e-05 0.2650960139      1 0.60664054  4.659900e-05
# CS=~A33 1.760217e+00       1 0.1845974875 -4.820404e-05 0.4457089906      1 0.50437976  3.514664e-05
# CS=~A34 9.850827e-01       1 0.3209471737  9.458781e-07 0.4019068028      1 0.52610614  3.792406e-05
# CS=~A37 2.281226e-01       1 0.6329193672  4.894342e-05 0.0740161553      1 0.78557658  5.871505e-05
# CS=~A38 8.889846e-01       1 0.3457526226  7.039297e-06 0.4480479515      1 0.50326341  3.499833e-05
# CS=~A39 1.027286e+00       1 0.3107969508 -1.730161e-06 0.4420819149      1 0.50611931  3.537663e-05
# CS=~A41 2.047917e-01       1 0.6508805992  5.042279e-05 0.0781058757      1 0.77988087  5.845573e-05
# wald.chi wald.df     wald.p
# RS=~A1           NA      NA         NA
# RS=~A3  4.760172279       1 0.02912563
# RS=~A20 0.702712566       1 0.40187373
# RS=~A42 1.024903276       1 0.31135876
# RS=~A44 4.766492484       1 0.02901889
# RS=~A45 0.810364224       1 0.36801259
# RS=~A46 0.515343048       1 0.47283499
# PF=~A2           NA      NA         NA
# PF=~A5  0.873270714       1 0.35005143
# PF=~A6  3.894750717       1 0.04843723
# PF=~A7  0.000171077       1 0.98956425
# PF=~A8  0.012335621       1 0.91156414
# PF=~A9  3.239153863       1 0.07189776
# WD=~A10          NA      NA         NA
# WD=~A11 0.969014824       1 0.32492600
# WD=~A13 1.763050290       1 0.18424450
# WD=~A21 0.161329531       1 0.68793539
# WD=~A22 0.158646918       1 0.69040533
# TM=~A17          NA      NA         NA
# TM=~A18 1.361531934       1 0.24327216
# TM=~A19 0.406864685       1 0.52356517
# TM=~A24 4.704979713       1 0.03007536
# TM=~A25 2.272776170       1 0.13166386
# FS=~A40          NA      NA         NA
# FS=~A35 4.631029198       1 0.03139872
# FS=~A36 5.846544841       1 0.01560767
# CS=~A4           NA      NA         NA
# CS=~A12 0.133271187       1 0.71506418
# CS=~A14 0.816680651       1 0.36615246
# CS=~A15 0.240422400       1 0.62390120
# CS=~A26 0.097004048       1 0.75545495
# CS=~A27 0.168373128       1 0.68156173
# CS=~A28 1.425834041       1 0.23244553
# CS=~A29 0.330555845       1 0.56533197
# CS=~A30 0.042043169       1 0.83753751
# CS=~A31 0.170654230       1 0.67953103
# CS=~A32 0.270299422       1 0.60313099
# CS=~A33 0.432308335       1 0.51085845
# CS=~A34 0.392442834       1 0.53101813
# CS=~A37 0.075373827       1 0.78366741
# CS=~A38 0.437692401       1 0.50823834
# CS=~A39 0.430601697       1 0.51169385
# CS=~A41 0.079940281       1 0.77737836


### Education
label_Education <- Measurement_invariance_addict_data$label1_Education
MI_Education_data <- cbind(label_Education,addict_useful)
MI_Education_data$label_Residence <- factor(MI_Education_data$label_Education,levels = c("1","2"))

addict_orig_6.E_config <- cfa(addict_orig_6.model, MI_Education_data, group="label_Residence")  
addict_orig_6.E_weak <- cfa(addict_orig_6.model, MI_Education_data, group="label_Residence", group.equal="loadings") 
addict_orig_6.E_strong<- cfa(addict_orig_6.model, MI_Education_data, group="label_Residence", group.equal= c("loadings", "intercepts"))
addict_orig_6.E_strict<- cfa(addict_orig_6.model, MI_Education_data, group="label_Residence", 
                           group.equal= c("loadings", "intercepts", "residuals"))

addict_orig_6.E_anova <- anova(addict_orig_6.E_config, addict_orig_6.E_weak, addict_orig_6.E_strong, addict_orig_6.E_strict)
# Chi-Squared Difference Test
# 
# Df   AIC   BIC  Chisq Chisq diff Df diff Pr(>Chisq)    
# addict_orig_6.E_config 1690 55032 56250 4615.0                                  
# addict_orig_6.E_weak   1727 55022 56083 4678.6     63.632      37   0.004181 ** 
#   addict_orig_6.E_strong 1764 54993 55898 4723.7     45.099      37   0.169351    
# addict_orig_6.E_strict 1807 55022 55745 4838.5    114.782      43  1.875e-08 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

addict_orig_6.E_MI <- semTools::measurementInvariance(model = addict_orig_6.model, data = MI_Education_data, group = "label_Education")
# Measurement invariance models:
#   
# Model 1 : fit.configural
# Model 2 : fit.loadings
# Model 3 : fit.intercepts
# Model 4 : fit.means
# 
# Chi-Squared Difference Test
# 
# Df   AIC   BIC  Chisq Chisq diff Df diff Pr(>Chisq)   
# fit.configural 1690 55032 56250 4615.0                                 
# fit.loadings   1727 55022 56083 4678.6     63.632      37   0.004181 **
#   fit.intercepts 1764 54993 55898 4723.7     45.099      37   0.169351   
# fit.means      1770 54988 55868 4731.1      7.372       6   0.287768   
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# 
# Fit measures:
#   
#   cfi rmsea cfi.delta rmsea.delta
# fit.configural 0.815 0.083        NA          NA
# fit.loadings   0.813 0.082     0.002       0.001
# fit.intercepts 0.813 0.081     0.001       0.001
# fit.means      0.813 0.081     0.000       0.000




addict_orig_6.E_partialInvariance <- semTools::partialInvariance(addict_orig_6.E_MI, "metric", free = NULL, fix = NULL, refgroup = 1,
                                                                 poolvar = TRUE, p.adjust = "none", fbound = 2, return.fit = FALSE) 

# $estimates
# poolest    load:1    load:2     std:1     std:2 diff_std:2 vs. 1    q:2 vs. 1 diff_mean:2 vs. 1
# RS=~A1  1.0000000 1.1716815 1.2893948 0.7409772 0.8154197      0.074442480  0.190350753       0.187096774
# RS=~A3  0.7817245 0.7344333 0.8089513 0.6000911 0.6609784      0.060887244  0.101259514       0.108971774
# RS=~A20 0.9905698 1.0021368 0.9839238 0.7557481 0.7420130     -0.013735079 -0.031281363       0.126713710
# RS=~A42 0.7762220 0.7260809 0.8084541 0.5905444 0.6575411      0.066996693  0.109967840       0.152654570
# RS=~A44 0.5684678 0.4726893 0.6329740 0.4958814 0.6640302      0.168148871  0.256158699       0.116498656
# RS=~A45 1.1559455 1.2915863 1.0890044 0.9880943 0.8331143     -0.154979985 -1.360725657       0.165322581
# RS=~A46 1.1740871 1.1653857 1.1799698 0.8875598 0.8986671      0.011107244  0.054938522       0.186223118
# PF=~A2  1.0000000 1.2152720 1.2464551 0.7352736 0.7541403      0.018866650  0.042374674       0.028225806
# PF=~A5  0.7566206 0.7477504 0.7615977 0.6684817 0.6808611      0.012379383  0.022724343       0.146370968
# PF=~A6  0.8374060 0.8249874 0.8442084 0.7992077 0.8178281      0.018620372  0.053808091       0.090994624
# PF=~A7  0.9226151 0.9583299 0.8934051 0.7482592 0.6975662     -0.050692944 -0.106443580       0.127049731
# PF=~A8  0.8725590 0.8964465 0.8542956 0.7197016 0.6858612     -0.033840355 -0.066927131       0.129065860
# PF=~A9  0.8952387 0.8783329 0.9041536 0.8147959 0.8387488      0.023952905  0.075803724       0.108971774
# WD=~A10 1.0000000 1.3987466 1.3159508 0.7203259 0.6776878     -0.042638118 -0.083496460       0.136895161
# WD=~A11 0.7628558 0.8871166 0.6966621 0.6808367 0.5346683     -0.146168467 -0.234012629      -0.095262097
# WD=~A13 0.6116582 0.4685191 0.6951042 0.4591503 0.6812044      0.222054081  0.335123666      -0.007526882
# WD=~A21 0.8382893 0.9214842 0.7956414 0.8667018 0.7483404     -0.118361379 -0.350497292      -0.103427419
# WD=~A22 1.0086883 0.9304100 1.0642535 0.7001244 0.8008403      0.100715956  0.233406460       0.096538978
# TM=~A17 1.0000000 1.2978654 1.0643751 0.6806096 0.5581657     -0.122443903 -0.200084034      -0.136189516
# TM=~A18 1.1764200 1.2769741 1.1474457 0.8735136 0.7849097     -0.088603846 -0.289685296       0.040288978
# TM=~A19 0.8078282 0.9326230 0.7572642 0.5591370 0.4540039     -0.105133148 -0.141844599      -0.005275538
# TM=~A24 0.6366444 0.5255410 0.7036010 0.5483737 0.7341697      0.185795995  0.321660248       0.098420699
# TM=~A25 0.9740359 0.9349462 0.9897402 0.7004666 0.7415186      0.041051960  0.085628419       0.091599462
# FS=~A40 1.0000000 1.1512105 1.0718664 0.7437588 0.6924972     -0.051261588 -0.106101435       0.016028226
# FS=~A35 1.3550607 1.3326463 1.3657398 0.7792185 0.7985688      0.019350252  0.051271204       0.066733871
# FS=~A36 1.4323863 1.4006336 1.4446175 0.8607919 0.8878232      0.027031346  0.115158200       0.084509409
# CS=~A4  1.0000000 0.9857435 1.0103101 0.6568798 0.6732504      0.016370650  0.029359379       0.183736559
# CS=~A12 1.1079674 1.1598312 1.0748032 0.7323164 0.6786298     -0.053686596 -0.107134816       0.110147849
# CS=~A14 1.1747721 1.2734577 1.0962016 0.7807509 0.6720760     -0.108674906 -0.232771268       0.070396505
# CS=~A15 0.9922729 0.9039427 1.0427445 0.5741798 0.6623461      0.088166218  0.143245531       0.094858871
# CS=~A26 1.2394372 1.2497659 1.2330157 0.7848173 0.7742987     -0.010518633 -0.026817995       0.074092742
# CS=~A27 1.3257163 1.3093498 1.3357701 0.8315127 0.8482912      0.016778406  0.057008070       0.128393817
# CS=~A28 1.2278890 1.1459687 1.2673553 0.7636260 0.8445131      0.080887038  0.231848430       0.118245968
# CS=~A29 1.4073567 1.2514585 1.4723826 0.7850967 0.9236924      0.138595702  0.555094747       0.062163978
# CS=~A30 1.4100228 1.4675659 1.3790215 0.8822947 0.8290621     -0.053232536 -0.200902022       0.231922043
# CS=~A31 1.2542175 1.3887770 1.1681007 0.8496964 0.7146799     -0.135016527 -0.358374878      -0.029569892
# CS=~A32 0.9063785 0.8052254 0.9456970 0.5167385 0.6068835      0.090145057  0.132093182       0.245262097
# CS=~A33 1.3561297 1.3703386 1.3495567 0.8257174 0.8131949     -0.012522466 -0.038135044       0.135181452
# CS=~A34 1.2074304 1.2063377 1.2081372 0.7164551 0.7175238      0.001068766  0.002199444       0.087163978
# CS=~A37 1.1601201 1.0726576 1.2062218 0.6706987 0.7542121      0.083513409  0.170641037       0.218750000
# CS=~A38 0.9602865 0.9491167 0.9659212 0.6563677 0.6679890      0.011621246  0.020697767       0.195430108
# CS=~A39 1.0805036 1.0688430 1.0863432 0.7028364 0.7143440      0.011507544  0.023114741       0.305712366
# CS=~A41 1.2647566 1.4391389 1.1393402 0.8488704 0.6720353     -0.176835127 -0.437650842      -0.038608871
# low_fscore:2 vs. 1 high_fscore:2 vs. 1
# RS=~A1         0.002033304          0.37216024
# RS=~A3        -0.038071765          0.25601531
# RS=~A20        0.162747067          0.09068035
# RS=~A42       -0.009820992          0.31513013
# RS=~A44       -0.198732183          0.43172950
# RS=~A45        0.571489729         -0.24084457
# RS=~A46        0.157429735          0.21501650
# PF=~A2        -0.013839763          0.07029138
# PF=~A5         0.123243855          0.16949808
# PF=~A6         0.058921899          0.12306735
# PF=~A7         0.235880626          0.01821884
# PF=~A8         0.199619025          0.05851270
# PF=~A9         0.065922656          0.15202089
# WD=~A10        0.247187817          0.02660251
# WD=~A11        0.249145262         -0.43966946
# WD=~A13       -0.405385542          0.39033178
# WD=~A21        0.125500267         -0.33235511
# WD=~A22       -0.139262859          0.33234082
# TM=~A17        0.190405717         -0.46278475
# TM=~A18        0.245010024         -0.16443207
# TM=~A19        0.270118009         -0.28066908
# TM=~A24       -0.176590573          0.37343197
# TM=~A25        0.006039892          0.17715903
# FS=~A40        0.106841049         -0.07478460
# FS=~A35        0.025530541          0.10793720
# FS=~A36        0.029811631          0.13920719
# CS=~A4         0.142702372          0.22477075
# CS=~A12        0.252468003         -0.03217230
# CS=~A14        0.367636599         -0.22684359
# CS=~A15       -0.136831397          0.32654914
# CS=~A26        0.102106537          0.04607895
# CS=~A27        0.084262915          0.17252472
# CS=~A28       -0.084038221          0.32053016
# CS=~A29       -0.304246454          0.42857441
# CS=~A30        0.380333231          0.08351086
# CS=~A31        0.340906129         -0.40004591
# CS=~A32        0.010684509          0.47983968
# CS=~A33        0.169939469          0.10042343
# CS=~A34        0.084155573          0.09017238
# CS=~A37       -0.004086845          0.44158684
# CS=~A38        0.167342636          0.22351758
# CS=~A39        0.276463014          0.33496172
# CS=~A41        0.465399669         -0.54261741
# 
# $results
# free.chi free.df      free.p      free.cfi      fix.chi fix.df      fix.p       fix.cfi
# RS=~A1  1.287847974       2 0.525227390  4.501412e-05           NA     NA         NA            NA
# RS=~A3  0.639624792       1 0.423846698  2.277881e-05 1.787265e-02      1 0.89364880  6.207888e-05
# RS=~A20 0.041127554       1 0.839291908  6.060897e-05 6.819688e-01      1 0.40890958  2.010230e-05
# RS=~A42 0.791898858       1 0.373526569  1.315378e-05 4.429781e-02      1 0.83330051  6.040859e-05
# RS=~A44 4.889252449       1 0.027024385 -2.458342e-04 1.703399e+00      1 0.19184405 -4.446086e-05
# RS=~A45 8.193073441       1 0.004205062 -4.546640e-04 5.456313e+00      1 0.01949774 -2.816773e-04
# RS=~A46 0.046414634       1 0.829423851  6.027478e-05 9.811022e-01      1 0.32192685  1.194504e-06
# PF=~A2  0.063684967       2 0.968659150  1.223917e-04           NA     NA         NA            NA
# PF=~A5  0.026718473       1 0.870157948  6.151975e-05 1.613159e-04      1 0.98986632  6.319839e-05
# PF=~A6  0.081029529       1 0.775907043  5.808683e-05 8.651692e-04      1 0.97653460  6.315390e-05
# PF=~A7  0.533194634       1 0.465266857  2.950611e-05 4.352212e-01      1 0.50943804  3.569887e-05
# PF=~A8  0.224789425       1 0.635414600  4.899997e-05 2.648834e-01      1 0.60678488  4.646568e-05
# PF=~A9  0.136591597       1 0.711693217  5.457483e-05 5.011511e-04      1 0.98213972  6.317691e-05
# WD=~A10 0.281874664       2 0.868543740  1.086003e-04           NA     NA         NA            NA
# WD=~A11 2.881399954       1 0.089608086 -1.189206e-04 9.976756e-01      1 0.31787360  1.469217e-07
# WD=~A13 6.822126335       1 0.009003531 -3.680084e-04 5.104252e+00      1 0.02386727 -2.594240e-04
# WD=~A21 2.363223698       1 0.124225243 -8.616744e-05 9.202562e-02      1 0.76161762  5.739178e-05
# WD=~A22 1.836074419       1 0.175411747 -5.284708e-05 1.034481e+00      1 0.30910863 -2.179468e-06
# TM=~A17 1.696257111       2 0.428215564  1.919916e-05           NA     NA         NA            NA
# TM=~A18 0.831056062       1 0.361967335  1.067871e-05 5.497336e-01      1 0.45842656  2.846070e-05
# TM=~A19 1.183068009       1 0.276732294 -1.157147e-05 1.045896e-02      1 0.91854311  6.254749e-05
# TM=~A24 4.951185750       1 0.026072780 -2.497489e-04 5.736595e+00      1 0.01661498 -2.993935e-04
# TM=~A25 0.229902890       1 0.631595843  4.867675e-05 2.419899e+00      1 0.11980268 -8.974979e-05
# FS=~A40 0.365766592       2 0.832865349  1.032976e-04           NA     NA         NA            NA
# FS=~A35 0.051559091       1 0.820372212  5.994961e-05 2.823921e-01      1 0.59513760  4.535898e-05
# FS=~A36 0.091492647       1 0.762288072  5.742547e-05 3.251620e-01      1 0.56852187  4.265556e-05
# CS=~A4  0.054542638       2 0.973097186  1.229696e-04           NA     NA         NA            NA
# CS=~A12 0.624141312       1 0.429512499  2.375750e-05 4.787876e-01      1 0.48897202  3.294510e-05
# CS=~A14 2.801841856       1 0.094156088 -1.138919e-04 1.514825e+00      1 0.21840434 -3.254135e-05
# CS=~A15 1.412432661       1 0.234652977 -2.606929e-05 5.105523e-01      1 0.47489987  3.093730e-05
# CS=~A26 0.029898867       1 0.862719901  6.131872e-05 5.715935e-02      1 0.81104338  5.959563e-05
# CS=~A27 0.098233070       1 0.753960411  5.699941e-05 4.404665e-07      1 0.99947046  6.320856e-05
# CS=~A28 1.906509535       1 0.167351501 -5.729919e-05 3.816645e-01      1 0.53671378  3.908411e-05
# CS=~A29 7.239168968       1 0.007132999 -3.943691e-04 1.038428e+00      1 0.30818739 -2.428972e-06
# CS=~A30 0.983906376       1 0.321236284  1.017255e-06 4.740459e-01      1 0.49113171  3.324481e-05
# CS=~A31 4.736737373       1 0.029525013 -2.361939e-04 2.119683e+00      1 0.14541661 -7.077360e-05
# CS=~A32 1.203005034       1 0.272721895 -1.283166e-05 6.421641e-01      1 0.42292825  2.261830e-05
# CS=~A33 0.045707478       1 0.830708428  6.031948e-05 1.052274e-01      1 0.74564449  5.655731e-05
# CS=~A34 0.000262062       1 0.987084145  6.319202e-05 2.884830e-02      1 0.86512978  6.138513e-05
# CS=~A37 1.538170976       1 0.214890257 -3.401703e-05 3.893676e-01      1 0.53263199  3.859721e-05
# CS=~A38 0.025246098       1 0.873755375  6.161282e-05 3.120656e-03      1 0.95545108  6.301134e-05
# CS=~A39 0.027653302       1 0.867926517  6.146066e-05 3.121258e-03      1 0.95544679  6.301130e-05
# CS=~A41 7.719691722       1 0.005462172 -4.247422e-04 3.573477e+00      1 0.05870926 -1.626659e-04
# wald.chi wald.df      wald.p
# RS=~A1            NA      NA          NA
# RS=~A3  0.0179153690       1 0.893522528
# RS=~A20 0.6582782090       1 0.417168459
# RS=~A42 0.0449241157       1 0.832143625
# RS=~A44 1.7906043451       1 0.180852547
# RS=~A45 4.9058385529       1 0.026766053
# RS=~A46 0.9515779549       1 0.329317967
# PF=~A2            NA      NA          NA
# PF=~A5  0.0001563017       1 0.990025054
# PF=~A6  0.0008906427       1 0.976191757
# PF=~A7  0.4300169628       1 0.511980625
# PF=~A8  0.2656263041       1 0.606280890
# PF=~A9  0.0005133180       1 0.981924257
# WD=~A10           NA      NA          NA
# WD=~A11 0.9980840542       1 0.317774555
# WD=~A13 5.4292125802       1 0.019802606
# WD=~A21 0.0982229917       1 0.753972625
# WD=~A22 1.1197508257       1 0.289972114
# TM=~A17           NA      NA          NA
# TM=~A18 0.5600012448       1 0.454259741
# TM=~A19 0.0106280899       1 0.917889456
# TM=~A24 7.1083771076       1 0.007672454
# TM=~A25 2.8238874048       1 0.092871229
# FS=~A40           NA      NA          NA
# FS=~A35 0.2932145270       1 0.588167912
# FS=~A36 0.3440453778       1 0.557503409
# CS=~A4            NA      NA          NA
# CS=~A12 0.4644912796       1 0.495532414
# CS=~A14 1.4476842469       1 0.228899898
# CS=~A15 0.5208371706       1 0.470484787
# CS=~A26 0.0567777951       1 0.811663222
# CS=~A27 0.0000000109       1 0.999916698
# CS=~A28 0.3947111399       1 0.529833364
# CS=~A29 1.1009508851       1 0.294057519
# CS=~A30 0.4611395503       1 0.497091884
# CS=~A31 2.0150276292       1 0.155748435
# CS=~A32 0.6628612077       1 0.415551643
# CS=~A33 0.1039060687       1 0.747191616
# CS=~A34 0.0287080923       1 0.865454790
# CS=~A37 0.4006743941       1 0.526741177
# CS=~A38 0.0030931236       1 0.955647832
# CS=~A39 0.0030914522       1 0.955659804
# CS=~A41 3.3557122560       1 0.066972233
































